Bootstrap: docker
From: rocm/pytorch:rocm6.3_ubuntu22.04_py3.10_pytorch_release_2.5.1_preview

%post
    conda env list
    conda install -y -n py_3.10 -c conda-forge mpi4py openmpi jupyter

%environment
    export LD_LIBRARY_PATH=/opt/rocm/lib:/usr/lib/openmpi/lib:$LD_LIBRARY_PATH
    export ROCM_PATH=/opt/rocm
    export PATH=/opt/conda/envs/py_3.10/bin:/opt/rocm/bin:/usr/lib/openmpi/bin:$PATH
    export OMPI_MCA_mtl="^ofi"
    export OMPI_MCA_pml="ob1"

    . /opt/conda/etc/profile.d/conda.sh
    conda activate py_3.10

%runscript
    echo "Welcome to the ROCm-aware Apptainer image!"
    source /opt/conda/bin/activate py_3.10
    exec "$@"

